



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.5.1">
    
    
      
        <title>Common table expressions - Beam Documentation</title>
      
    
    

      <link rel="stylesheet" href="../../../assets/stylesheets/application.1b62728e.css">
      
      
    
<link rel="stylesheet" type="text/css" href="../../../css/beam.css"/>

    
      <script src="../../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../docs/theme/css/beam.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#lets-start-with-an-example" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Beam Documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Beam Documentation
            </span>
            <span class="md-header-nav__topic">
              
                Common table expressions
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/haskell-beam/beam/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    haskell-beam/beam
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="Beam Documentation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Beam Documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/haskell-beam/beam/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    haskell-beam/beam
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../about/faq/" title="Frequently Asked Questions" class="md-nav__link">
      Frequently Asked Questions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorials/tutorial1/" title="Part 1" class="md-nav__link">
      Part 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorials/tutorial2/" title="Part 2" class="md-nav__link">
      Part 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorials/tutorial3/" title="Part 3" class="md-nav__link">
      Part 3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      User Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../models/" title="Models" class="md-nav__link">
      Models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../databases/" title="Databases" class="md-nav__link">
      Databases
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../backends/" title="Backends" class="md-nav__link">
      Backends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../expressions/" title="Expressions" class="md-nav__link">
      Expressions
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-5" type="checkbox" id="nav-4-5" checked>
    
    <label class="md-nav__link" for="nav-4-5">
      Queries
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-5">
        Queries
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../basic/" title="Basic Queries" class="md-nav__link">
      Basic Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../select/" title="More complex SELECTs" class="md-nav__link">
      More complex SELECTs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ordering/" title="Ordering" class="md-nav__link">
      Ordering
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../relationships/" title="Relationships" class="md-nav__link">
      Relationships
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aggregates/" title="Aggregates" class="md-nav__link">
      Aggregates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../combining-queries/" title="Combining queries" class="md-nav__link">
      Combining queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../window-functions/" title="Window functions" class="md-nav__link">
      Window functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../advanced-features/" title="Advanced features" class="md-nav__link">
      Advanced features
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Common table expressions
      </label>
    
    <a href="./" title="Common table expressions" class="md-nav__link md-nav__link--active">
      Common table expressions
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lets-start-with-an-example" class="md-nav__link">
    Let's start with an example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-selectwith-function" class="md-nav__link">
    The selectWith function
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#binding-subqueries-with-selecting" class="md-nav__link">
    Binding subqueries with selecting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-query-with-reuse" class="md-nav__link">
    Using the query with reuse
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#refining-our-query" class="md-nav__link">
    Refining our query
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reusing-queries-multiple-times" class="md-nav__link">
    Reusing queries multiple times
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recursive-queries" class="md-nav__link">
    Recursive queries
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../extensibility/" title="Custom queries" class="md-nav__link">
      Custom queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-7" type="checkbox" id="nav-4-7">
    
    <label class="md-nav__link" for="nav-4-7">
      Data Manipulation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-7">
        Data Manipulation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../manipulation/insert/" title="INSERT" class="md-nav__link">
      INSERT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../manipulation/update/" title="UPDATE" class="md-nav__link">
      UPDATE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../manipulation/delete/" title="DELETE" class="md-nav__link">
      DELETE
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Schema management
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Schema management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../schema-guide/migrations/" title="The Migrations Framework" class="md-nav__link">
      The Migrations Framework
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../schema-guide/tool/" title="The beam-migrate tool" class="md-nav__link">
      The beam-migrate tool
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../schema-guide/library/" title="The beam-migrate library" class="md-nav__link">
      The beam-migrate library
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Backends
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Backends
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../backends/beam-postgres/" title="beam-postgres" class="md-nav__link">
      beam-postgres
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../backends/beam-sqlite/" title="beam-sqlite" class="md-nav__link">
      beam-sqlite
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../custom-backends/" title="Writing a Custom Backend" class="md-nav__link">
      Writing a Custom Backend
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/compatibility/" title="Compatibility Matrix" class="md-nav__link">
      Compatibility Matrix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/release-notes/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lets-start-with-an-example" class="md-nav__link">
    Let's start with an example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-selectwith-function" class="md-nav__link">
    The selectWith function
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#binding-subqueries-with-selecting" class="md-nav__link">
    Binding subqueries with selecting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-query-with-reuse" class="md-nav__link">
    Using the query with reuse
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#refining-our-query" class="md-nav__link">
    Refining our query
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reusing-queries-multiple-times" class="md-nav__link">
    Reusing queries multiple times
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recursive-queries" class="md-nav__link">
    Recursive queries
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/haskell-beam/beam/edit/master/docs/user-guide/queries/common-table-expressions.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Common table expressions</h1>
                
                <p>Common table expressions are a SQL99 feature that allow you to reuse common
subqueries in your queries. There is often no semantic difference between CTEs
and reusing Beam queries, but backends sometimes have optimizations that will
only fire when using CTEs. Common table expressions are also necessary to write
<em>recursive</em> queries.</p>
<h2 id="lets-start-with-an-example">Let's start with an example</h2>
<p>Common table expressions are complicated, so let's start with an example.</p>
<p>In the <a href="../window-functions/">window function</a> section, we saw how to
find the genre representing the most tracks in a particular album.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-0-Haskell" aria-controls="tab-0-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-0-Postgres" aria-controls="tab-0-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-0-Haskell">
            <div class="codehilite"><pre><span></span><span class="kr">let</span> <span class="n">albumGenreCnts</span> <span class="ow">=</span> <span class="n">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackAlbumId</span> <span class="n">t</span><span class="p">)</span>
                                <span class="p">,</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackGenreId</span> <span class="n">t</span><span class="p">)</span>
                                <span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="n">countAll_</span> <span class="p">))</span> <span class="o">$</span>
                     <span class="n">all_</span> <span class="p">(</span><span class="n">track</span> <span class="n">chinookDb</span><span class="p">)</span>

    <span class="n">withMaxCounts</span> <span class="ow">=</span> <span class="n">withWindow_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">frame_</span> <span class="p">(</span><span class="n">partitionBy_</span> <span class="n">albumId</span><span class="p">)</span> <span class="n">noOrder_</span> <span class="n">noBounds_</span><span class="p">)</span>
                                <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">)</span> <span class="n">albumWindow</span> <span class="ow">-&gt;</span>
                                    <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">max_</span> <span class="n">trackCnt</span> <span class="p">`</span><span class="n">over_</span><span class="p">`</span> <span class="n">albumWindow</span><span class="p">))</span> <span class="o">$</span>
                    <span class="n">albumGenreCnts</span>
<span class="kr">in</span> <span class="n">filter_&#39;</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">maxTrackCntPerAlbum</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">just_</span> <span class="n">trackCnt</span> <span class="o">==?.</span> <span class="n">maxTrackCntPerAlbum</span><span class="p">)</span> <span class="n">withMaxCounts</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-0-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res2&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res3&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span>
<span class="k">FROM</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
          <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
          <span class="k">MAX</span><span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">))</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span>
   <span class="k">FROM</span> <span class="ss">&quot;Track&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
   <span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">,</span>
            <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res3&quot;</span><span class="p">)</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>Now, suppose that, instead of the album and genre ids, we wanted the names,
along with the name of the artist who produced the album. We can do this by just
joining over the above</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-1-Haskell" aria-controls="tab-1-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-1-Postgres" aria-controls="tab-1-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-1-Haskell">
            <div class="codehilite"><pre><span></span><span class="kr">let</span> <span class="n">albumGenreCnts</span> <span class="ow">=</span> <span class="n">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackAlbumId</span> <span class="n">t</span><span class="p">)</span>
                                <span class="p">,</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackGenreId</span> <span class="n">t</span><span class="p">)</span>
                                <span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="n">countAll_</span> <span class="p">))</span> <span class="o">$</span>
                     <span class="n">all_</span> <span class="p">(</span><span class="n">track</span> <span class="n">chinookDb</span><span class="p">)</span>

    <span class="n">withMaxCounts</span> <span class="ow">=</span> <span class="n">withWindow_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">frame_</span> <span class="p">(</span><span class="n">partitionBy_</span> <span class="n">albumId</span><span class="p">)</span> <span class="n">noOrder_</span> <span class="n">noBounds_</span><span class="p">)</span>
                                <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">)</span> <span class="n">albumWindow</span> <span class="ow">-&gt;</span>
                                    <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">max_</span> <span class="n">trackCnt</span> <span class="p">`</span><span class="n">over_</span><span class="p">`</span> <span class="n">albumWindow</span><span class="p">))</span> <span class="o">$</span>
                    <span class="n">albumGenreCnts</span>

    <span class="n">albumAndRepresentativeGenres</span> <span class="ow">=</span> <span class="n">filter_&#39;</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">maxTrackCntPerAlbum</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">just_</span> <span class="n">trackCnt</span> <span class="o">==?.</span> <span class="n">maxTrackCntPerAlbum</span><span class="p">)</span> <span class="n">withMaxCounts</span>

<span class="kr">in</span> <span class="kr">do</span>
  <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">albumAndRepresentativeGenres</span>

  <span class="n">genre_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">genre</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">g</span> <span class="ow">-&gt;</span> <span class="n">genreId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">g</span><span class="p">))</span>
  <span class="n">album_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">album</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">a</span><span class="p">))</span>

  <span class="n">artistName</span> <span class="ow">&lt;-</span> <span class="n">fmap</span> <span class="n">artistName</span> <span class="o">$</span>
                <span class="n">join_</span> <span class="p">(</span><span class="n">artist</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumArtist</span> <span class="n">album_</span> <span class="p">`</span><span class="n">references_</span><span class="p">`</span> <span class="n">a</span><span class="p">)</span>

  <span class="n">pure</span> <span class="p">(</span> <span class="n">artistName</span><span class="p">,</span> <span class="n">albumTitle</span> <span class="n">album_</span><span class="p">,</span> <span class="n">genreName</span> <span class="n">genre_</span> <span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-1-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;Title&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
          <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
          <span class="k">MAX</span><span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">))</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span>
   <span class="k">FROM</span> <span class="ss">&quot;Track&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
   <span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">,</span>
            <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Genre&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Album&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t2&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Artist&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t3&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res3&quot;</span><span class="p">)</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>Because we're using Beam, and Beam is just Haskell, we are free to compose
queries arbitrarily, and get the right results. However, the generated SQL is a
bit dense, and some backends may not optimize it well. Moreover, if we plan on
using <code>albumAndRepresentativeGenres</code> more than once, then we'd like to express
this syntactically, rather than repeating the query wherever we need it. In
other words, we want to be able to signal the concept of re-use to the database
system.</p>
<h2 id="the-selectwith-function">The <code>selectWith</code> function</h2>
<p>We can rewrite the above query using common table expressions. Firstly, we'll
have to tell Beam that we want to write a <code>SELECT</code> statement with a <code>WITH</code>
expression. We can do this by using <code>selectWith</code> instead of
<code>select</code>. <code>selectWith</code> takes one argument, which is a monadic action returning a
query. The monad expected is the <code>With</code> monad from
<code>Database.Beam.Query.CTE</code>. Within this monad, bindings represent queries we
would like bound at the top-level.</p>
<p>So, let's start building our query using <code>selectWith</code>. We'll want to return a
list, so we'll use <code>runSelectReturningList</code>.</p>
<div class="codehilite"><pre><span></span><span class="nf">runSelectReturningList</span> <span class="o">$</span> <span class="n">selectWith</span> <span class="o">$</span> <span class="kr">do</span>
</pre></div>


<h2 id="binding-subqueries-with-selecting">Binding subqueries with <code>selecting</code></h2>
<p>Now, we're in the <code>With</code> monad, so we can start binding common table
expressions. We can bind multiple different types of results here. On all
backends that support CTEs, you can bind the results of <code>SELECT</code>, but in some
backends, you can bind the results of <code>INSERT</code>, <code>DELETE</code>, <code>UPDATE</code>, etc.</p>
<p>In our case, we would like to bind the results of a <code>SELECT</code> statement, so we
can use the <code>selecting</code> function. This function takes a query (represented by a
value of type <code>Q</code>) and returns a <code>ReusableQ</code>, which is a query value that can be
re-used elsewhere.</p>
<p>A <code>ReusableQ</code> is parameterized by three paramaters</p>
<div class="codehilite"><pre><span></span><span class="kr">data</span> <span class="kt">ReusableQ</span> <span class="n">be</span> <span class="n">db</span> <span class="n">res</span>
</pre></div>


<ul>
<li><code>be</code> -- This is the backend that the query is in. For example, <code>Postgres</code> for
  <code>beam-postgres</code> or <code>Sqlite</code> for <code>beam-sqlite</code>.</li>
<li><code>db</code> -- This is the type of the database the query is written over</li>
<li><code>res</code> -- This is the type of each row returned by the query.</li>
</ul>
<p>Notice that <code>ReusableQ</code> has no scoping parameter like regular <code>Q</code>
expressions. This is because <code>ReusableQ</code> values can be rescoped at any
level. We'll get to this in the next section.</p>
<p>We can introduce the <code>albumAndRepresentativeGenres</code> query into the <code>With</code> monad
using <code>selecting</code>.</p>
<div class="codehilite"><pre><span></span>  <span class="n">albumAndRepresentativeGenres</span> <span class="ow">&lt;-</span>
    <span class="n">selecting</span> <span class="o">$</span>
    <span class="kr">let</span> <span class="n">albumGenreCnts</span> <span class="ow">=</span> <span class="n">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackAlbumId</span> <span class="n">t</span><span class="p">)</span>
                                    <span class="p">,</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackGenreId</span> <span class="n">t</span><span class="p">)</span>
                                    <span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="n">countAll_</span> <span class="p">))</span> <span class="o">$</span>
                         <span class="n">all_</span> <span class="p">(</span><span class="n">track</span> <span class="n">chinookDb</span><span class="p">)</span>

        <span class="n">withMaxCounts</span> <span class="ow">=</span> <span class="n">withWindow_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">frame_</span> <span class="p">(</span><span class="n">partitionBy_</span> <span class="n">albumId</span><span class="p">)</span> <span class="n">noOrder_</span> <span class="n">noBounds_</span><span class="p">)</span>
                                    <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">)</span> <span class="n">albumWindow</span> <span class="ow">-&gt;</span>
                                        <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">max_</span> <span class="n">trackCnt</span> <span class="p">`</span><span class="n">over_</span><span class="p">`</span> <span class="n">albumWindow</span><span class="p">))</span> <span class="o">$</span>
                        <span class="n">albumGenreCnts</span>
    <span class="kr">in</span> <span class="n">filter_&#39;</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">maxTrackCntPerAlbum</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">just_</span> <span class="n">trackCnt</span> <span class="o">==?.</span> <span class="n">maxTrackCntPerAlbum</span><span class="p">)</span> <span class="n">withMaxCounts</span>
</pre></div>


<h2 id="using-the-query-with-reuse">Using the query with <code>reuse</code></h2>
<p>Now that we have taken that query out of scope, we'll need the ability to refer
to its result. Queries are in the <code>Q</code> monad, but <code>albumAndRepresentativeGenres</code>
has type <code>ReusableQ</code>. In order to use the value in the <code>Q</code> monad, we can use the
<code>reuse</code> function. This utility function ensures that the query is able to be
used at any nesting level.</p>
<p>Also note that since we're in the <code>With</code> monad, we'll need to inject our query
into that using <code>pure</code>.</p>
<div class="codehilite"><pre><span></span>  <span class="n">pure</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="p">(</span><span class="n">albumId</span><span class="o">@</span><span class="p">(</span><span class="kt">AlbumId</span> <span class="n">albumIdColumn</span><span class="p">),</span> <span class="n">genreId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">&lt;-</span>
       <span class="n">reuse</span> <span class="n">albumGenreCountQ</span>
    <span class="n">genre_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">genre</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">g</span> <span class="ow">-&gt;</span> <span class="n">genreId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">g</span><span class="p">))</span>
    <span class="n">album_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">album</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">a</span><span class="p">))</span>
    <span class="n">artist_</span> <span class="ow">&lt;-</span> <span class="n">join_</span> <span class="p">(</span><span class="n">artist</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumArtist</span> <span class="n">album_</span> <span class="p">`</span><span class="n">references_</span><span class="p">`</span> <span class="n">a</span><span class="p">)</span>

    <span class="n">pure</span> <span class="p">(</span> <span class="n">artistName</span> <span class="n">artist_</span><span class="p">,</span> <span class="n">albumTitle</span> <span class="n">album_</span><span class="p">,</span> <span class="n">genreName</span> <span class="n">genre_</span> <span class="p">)</span>
</pre></div>


<p>Phew! Putting all of that together, and executing, we get...</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-2-Haskell" aria-controls="tab-2-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-2-Postgres" aria-controls="tab-2-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-2-Haskell">
            <div class="codehilite"><pre><span></span><span class="nf">void</span> <span class="o">$</span> <span class="n">runSelectReturningList</span> <span class="o">$</span> <span class="n">selectWith</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="n">albumAndRepresentativeGenres</span> <span class="ow">&lt;-</span>
    <span class="n">selecting</span> <span class="o">$</span>
    <span class="kr">let</span> <span class="n">albumGenreCnts</span> <span class="ow">=</span> <span class="n">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackAlbumId</span> <span class="n">t</span><span class="p">)</span>
                                    <span class="p">,</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackGenreId</span> <span class="n">t</span><span class="p">)</span>
                                    <span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="n">countAll_</span> <span class="p">))</span> <span class="o">$</span>
                         <span class="n">all_</span> <span class="p">(</span><span class="n">track</span> <span class="n">chinookDb</span><span class="p">)</span>

        <span class="n">withMaxCounts</span> <span class="ow">=</span> <span class="n">withWindow_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">frame_</span> <span class="p">(</span><span class="n">partitionBy_</span> <span class="n">albumId</span><span class="p">)</span> <span class="n">noOrder_</span> <span class="n">noBounds_</span><span class="p">)</span>
                                    <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">)</span> <span class="n">albumWindow</span> <span class="ow">-&gt;</span>
                                        <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">max_</span> <span class="n">trackCnt</span> <span class="p">`</span><span class="n">over_</span><span class="p">`</span> <span class="n">albumWindow</span><span class="p">))</span> <span class="o">$</span>
                        <span class="n">albumGenreCnts</span>
    <span class="kr">in</span> <span class="n">filter_&#39;</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">maxTrackCntPerAlbum</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">just_</span> <span class="n">trackCnt</span> <span class="o">==?.</span> <span class="n">maxTrackCntPerAlbum</span><span class="p">)</span> <span class="n">withMaxCounts</span>

  <span class="n">pure</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">&lt;-</span>
       <span class="n">reuse</span> <span class="n">albumAndRepresentativeGenres</span>
    <span class="n">genre_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">genre</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">g</span> <span class="ow">-&gt;</span> <span class="n">genreId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">g</span><span class="p">))</span>
    <span class="n">album_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">album</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">a</span><span class="p">))</span>
    <span class="n">artist_</span> <span class="ow">&lt;-</span> <span class="n">join_</span> <span class="p">(</span><span class="n">artist</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumArtist</span> <span class="n">album_</span> <span class="p">`</span><span class="n">references_</span><span class="p">`</span> <span class="n">a</span><span class="p">)</span>

    <span class="n">pure</span> <span class="p">(</span> <span class="n">artistName</span> <span class="n">artist_</span><span class="p">,</span> <span class="n">albumTitle</span> <span class="n">album_</span><span class="p">,</span> <span class="n">genreName</span> <span class="n">genre_</span> <span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-2-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">WITH</span> <span class="ss">&quot;cte0&quot;</span><span class="p">(</span><span class="ss">&quot;res0&quot;</span><span class="p">,</span>
            <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
            <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
            <span class="ss">&quot;res3&quot;</span><span class="p">)</span> <span class="k">AS</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
          <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
          <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res2&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
          <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res3&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span>
   <span class="k">FROM</span>
     <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
             <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
             <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
             <span class="k">MAX</span><span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">))</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span>
      <span class="k">FROM</span> <span class="ss">&quot;Track&quot;</span> <span class="k">AS</span> <span class="ss">&quot;cte0_0&quot;</span>
      <span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">,</span>
               <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;cte0_0&quot;</span>
   <span class="k">WHERE</span> <span class="p">(</span><span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res3&quot;</span><span class="p">))</span>
<span class="k">SELECT</span> <span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;Title&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;cte0&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Genre&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Album&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t2&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Artist&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t3&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">);</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h3 id="refining-our-query">Refining our query</h3>
<p>Notice that the <code>filter_'</code> condition on the common table expression resulted in
a nasty subselect. We can get rid of that by introducing the <code>filter_'</code> in the
outer query.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-3-Haskell" aria-controls="tab-3-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-3-Postgres" aria-controls="tab-3-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-3-Haskell">
            <div class="codehilite"><pre><span></span><span class="nf">void</span> <span class="o">$</span> <span class="n">runSelectReturningList</span> <span class="o">$</span> <span class="n">selectWith</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="n">albumAndRepresentativeGenres</span> <span class="ow">&lt;-</span>
    <span class="n">selecting</span> <span class="o">$</span>
    <span class="kr">let</span> <span class="n">albumGenreCnts</span> <span class="ow">=</span> <span class="n">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackAlbumId</span> <span class="n">t</span><span class="p">)</span>
                                    <span class="p">,</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackGenreId</span> <span class="n">t</span><span class="p">)</span>
                                    <span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="n">countAll_</span> <span class="p">))</span> <span class="o">$</span>
                         <span class="n">all_</span> <span class="p">(</span><span class="n">track</span> <span class="n">chinookDb</span><span class="p">)</span>

    <span class="kr">in</span> <span class="n">withWindow_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">frame_</span> <span class="p">(</span><span class="n">partitionBy_</span> <span class="n">albumId</span><span class="p">)</span> <span class="n">noOrder_</span> <span class="n">noBounds_</span><span class="p">)</span>
                   <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">)</span> <span class="n">albumWindow</span> <span class="ow">-&gt;</span>
                       <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">max_</span> <span class="n">trackCnt</span> <span class="p">`</span><span class="n">over_</span><span class="p">`</span> <span class="n">albumWindow</span><span class="p">))</span> <span class="o">$</span>
       <span class="n">albumGenreCnts</span>

  <span class="n">pure</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">&lt;-</span>
       <span class="n">filter_&#39;</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">maxTrackCntInAlbum</span><span class="p">)</span> <span class="ow">-&gt;</span>
                     <span class="n">just_</span> <span class="n">trackCnt</span> <span class="o">==?.</span> <span class="n">maxTrackCntInAlbum</span><span class="p">)</span> <span class="o">$</span>
       <span class="n">reuse</span> <span class="n">albumAndRepresentativeGenres</span>
    <span class="n">genre_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">genre</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">g</span> <span class="ow">-&gt;</span> <span class="n">genreId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">g</span><span class="p">))</span>
    <span class="n">album_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">album</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">a</span><span class="p">))</span>
    <span class="n">artist_</span> <span class="ow">&lt;-</span> <span class="n">join_</span> <span class="p">(</span><span class="n">artist</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumArtist</span> <span class="n">album_</span> <span class="p">`</span><span class="n">references_</span><span class="p">`</span> <span class="n">a</span><span class="p">)</span>

    <span class="n">pure</span> <span class="p">(</span> <span class="n">artistName</span> <span class="n">artist_</span><span class="p">,</span> <span class="n">albumTitle</span> <span class="n">album_</span><span class="p">,</span> <span class="n">genreName</span> <span class="n">genre_</span> <span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-3-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">WITH</span> <span class="ss">&quot;cte0&quot;</span><span class="p">(</span><span class="ss">&quot;res0&quot;</span><span class="p">,</span>
            <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
            <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
            <span class="ss">&quot;res3&quot;</span><span class="p">)</span> <span class="k">AS</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
          <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
          <span class="k">MAX</span><span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">))</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span>
   <span class="k">FROM</span> <span class="ss">&quot;Track&quot;</span> <span class="k">AS</span> <span class="ss">&quot;cte0_0&quot;</span>
   <span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">,</span>
            <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;Title&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;cte0&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Genre&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Album&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t2&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Artist&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t3&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res3&quot;</span><span class="p">);</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>To demonstrate that we can still use all beam's features, let's only return
results for albums with tracks of more than one genre. We can do this by using a
quantified comparison operator on the album id column, and a subquery to find
all albums with more than one genre.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-4-Haskell" aria-controls="tab-4-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-4-Postgres" aria-controls="tab-4-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-4-Haskell">
            <div class="codehilite"><pre><span></span><span class="nf">void</span> <span class="o">$</span> <span class="n">runSelectReturningList</span> <span class="o">$</span> <span class="n">selectWith</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="n">albumAndRepresentativeGenres</span> <span class="ow">&lt;-</span>
    <span class="n">selecting</span> <span class="o">$</span>
    <span class="kr">let</span> <span class="n">albumGenreCnts</span> <span class="ow">=</span> <span class="n">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackAlbumId</span> <span class="n">t</span><span class="p">)</span>
                                    <span class="p">,</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackGenreId</span> <span class="n">t</span><span class="p">)</span>
                                    <span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="n">countAll_</span> <span class="p">))</span> <span class="o">$</span>
                         <span class="n">all_</span> <span class="p">(</span><span class="n">track</span> <span class="n">chinookDb</span><span class="p">)</span>

    <span class="kr">in</span> <span class="n">withWindow_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">frame_</span> <span class="p">(</span><span class="n">partitionBy_</span> <span class="n">albumId</span><span class="p">)</span> <span class="n">noOrder_</span> <span class="n">noBounds_</span><span class="p">)</span>
                   <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">)</span> <span class="n">albumWindow</span> <span class="ow">-&gt;</span>
                       <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">max_</span> <span class="n">trackCnt</span> <span class="p">`</span><span class="n">over_</span><span class="p">`</span> <span class="n">albumWindow</span><span class="p">))</span> <span class="o">$</span>
       <span class="n">albumGenreCnts</span>

  <span class="n">pure</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="p">(</span><span class="n">albumId</span><span class="o">@</span><span class="p">(</span><span class="kt">AlbumId</span> <span class="n">albumIdColumn</span><span class="p">),</span> <span class="n">genreId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">&lt;-</span>
       <span class="n">filter_&#39;</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">maxTrackCntInAlbum</span><span class="p">)</span> <span class="ow">-&gt;</span>
                     <span class="n">just_</span> <span class="n">trackCnt</span> <span class="o">==?.</span> <span class="n">maxTrackCntInAlbum</span><span class="p">)</span> <span class="o">$</span>
       <span class="n">reuse</span> <span class="n">albumAndRepresentativeGenres</span>
    <span class="n">genre_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">genre</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">g</span> <span class="ow">-&gt;</span> <span class="n">genreId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">g</span><span class="p">))</span>
    <span class="n">album_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">album</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">a</span><span class="p">))</span>
    <span class="n">artist_</span> <span class="ow">&lt;-</span> <span class="n">join_</span> <span class="p">(</span><span class="n">artist</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumArtist</span> <span class="n">album_</span> <span class="p">`</span><span class="n">references_</span><span class="p">`</span> <span class="n">a</span><span class="p">)</span>

    <span class="c1">-- Filter out all albums with tracks of only one genre</span>
    <span class="n">guard_&#39;</span> <span class="p">(</span><span class="n">albumIdColumn</span> <span class="o">==*.</span>
             <span class="n">anyOf_</span> <span class="p">(</span><span class="n">orderBy_</span> <span class="n">asc_</span> <span class="o">$</span> <span class="n">fmap</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kt">AlbumId</span> <span class="n">albumIdRaw</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">albumIdRaw</span><span class="p">)</span> <span class="o">$</span>
                     <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="n">genreCntByAlbum</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">genreCntByAlbum</span> <span class="o">&gt;.</span> <span class="mi">1</span><span class="p">)</span> <span class="o">$</span>
                     <span class="n">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="kr">let</span> <span class="kt">GenreId</span> <span class="n">genreId</span> <span class="ow">=</span> <span class="n">trackGenreId</span> <span class="n">t</span>
                                       <span class="kr">in</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackAlbumId</span> <span class="n">t</span><span class="p">)</span>
                                          <span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="p">(</span><span class="n">countOver_</span> <span class="n">distinctInGroup_</span> <span class="n">genreId</span><span class="p">)))</span> <span class="o">$</span>
                     <span class="n">all_</span> <span class="p">(</span><span class="n">track</span> <span class="n">chinookDb</span><span class="p">)))</span>

    <span class="n">pure</span> <span class="p">(</span> <span class="n">artistName</span> <span class="n">artist_</span><span class="p">,</span> <span class="n">albumTitle</span> <span class="n">album_</span><span class="p">,</span> <span class="n">genreName</span> <span class="n">genre_</span> <span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-4-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">WITH</span> <span class="ss">&quot;cte0&quot;</span><span class="p">(</span><span class="ss">&quot;res0&quot;</span><span class="p">,</span>
            <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
            <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
            <span class="ss">&quot;res3&quot;</span><span class="p">)</span> <span class="k">AS</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
          <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
          <span class="k">MAX</span><span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">))</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span>
   <span class="k">FROM</span> <span class="ss">&quot;Track&quot;</span> <span class="k">AS</span> <span class="ss">&quot;cte0_0&quot;</span>
   <span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">,</span>
            <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;Title&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;cte0&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Genre&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Album&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t2&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Artist&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t3&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res3&quot;</span><span class="p">))</span>
  <span class="k">AND</span> <span class="p">((</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="k">ANY</span>
         <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;sub_t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span>
          <span class="k">FROM</span> <span class="ss">&quot;Track&quot;</span> <span class="k">AS</span> <span class="ss">&quot;sub_t0&quot;</span>
          <span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;sub_t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span>
          <span class="k">HAVING</span> <span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="ss">&quot;sub_t0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">&quot;sub_t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">ASC</span><span class="p">));</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>without CTEs,</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-5-Haskell" aria-controls="tab-5-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-5-Postgres" aria-controls="tab-5-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-5-Haskell">
            <div class="codehilite"><pre><span></span><span class="kr">do</span> <span class="kr">let</span> <span class="n">albumGenreCnts</span> <span class="ow">=</span> <span class="n">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackAlbumId</span> <span class="n">t</span><span class="p">)</span>
                                   <span class="p">,</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackGenreId</span> <span class="n">t</span><span class="p">)</span>
                                   <span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="n">countAll_</span> <span class="p">))</span> <span class="o">$</span>
                        <span class="n">all_</span> <span class="p">(</span><span class="n">track</span> <span class="n">chinookDb</span><span class="p">)</span>

       <span class="n">albumAndRepresentativeGenres</span> <span class="ow">=</span>
         <span class="n">withWindow_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">frame_</span> <span class="p">(</span><span class="n">partitionBy_</span> <span class="n">albumId</span><span class="p">)</span> <span class="n">noOrder_</span> <span class="n">noBounds_</span><span class="p">)</span>
                     <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">)</span> <span class="n">albumWindow</span> <span class="ow">-&gt;</span>
                         <span class="p">(</span><span class="n">albumId</span><span class="p">,</span> <span class="n">genreId</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">max_</span> <span class="n">trackCnt</span> <span class="p">`</span><span class="n">over_</span><span class="p">`</span> <span class="n">albumWindow</span><span class="p">))</span> <span class="o">$</span>
           <span class="n">albumGenreCnts</span>


   <span class="p">(</span><span class="n">albumId</span><span class="o">@</span><span class="p">(</span><span class="kt">AlbumId</span> <span class="n">albumIdColumn</span><span class="p">),</span> <span class="n">genreId</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">&lt;-</span>
      <span class="n">filter_&#39;</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">trackCnt</span><span class="p">,</span> <span class="n">maxTrackCntInAlbum</span><span class="p">)</span> <span class="ow">-&gt;</span>
                    <span class="n">just_</span> <span class="n">trackCnt</span> <span class="o">==?.</span> <span class="n">maxTrackCntInAlbum</span><span class="p">)</span> <span class="o">$</span>
      <span class="n">albumAndRepresentativeGenres</span>
   <span class="n">genre_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">genre</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">g</span> <span class="ow">-&gt;</span> <span class="n">genreId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">g</span><span class="p">))</span>
   <span class="n">album_</span> <span class="ow">&lt;-</span> <span class="n">join_&#39;</span> <span class="p">(</span><span class="n">album</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumId</span> <span class="o">==?.</span> <span class="n">just_</span> <span class="p">(</span><span class="n">primaryKey</span> <span class="n">a</span><span class="p">))</span>
   <span class="n">artist_</span> <span class="ow">&lt;-</span> <span class="n">join_</span> <span class="p">(</span><span class="n">artist</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">albumArtist</span> <span class="n">album_</span> <span class="p">`</span><span class="n">references_</span><span class="p">`</span> <span class="n">a</span><span class="p">)</span>

   <span class="c1">-- Filter out all albums with tracks of only one genre</span>
   <span class="n">guard_&#39;</span> <span class="p">(</span><span class="n">albumIdColumn</span> <span class="o">==*.</span>
            <span class="n">anyOf_</span> <span class="p">(</span><span class="n">orderBy_</span> <span class="n">asc_</span> <span class="o">$</span> <span class="n">fmap</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kt">AlbumId</span> <span class="n">albumIdRaw</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">albumIdRaw</span><span class="p">)</span> <span class="o">$</span>
                    <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="n">genreCntByAlbum</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">genreCntByAlbum</span> <span class="o">&gt;.</span> <span class="mi">1</span><span class="p">)</span> <span class="o">$</span>
                    <span class="n">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="kr">let</span> <span class="kt">GenreId</span> <span class="n">genreId</span> <span class="ow">=</span> <span class="n">trackGenreId</span> <span class="n">t</span>
                                      <span class="kr">in</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">trackAlbumId</span> <span class="n">t</span><span class="p">)</span>
                                         <span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="p">(</span><span class="n">countOver_</span> <span class="n">distinctInGroup_</span> <span class="n">genreId</span><span class="p">)))</span> <span class="o">$</span>
                    <span class="n">all_</span> <span class="p">(</span><span class="n">track</span> <span class="n">chinookDb</span><span class="p">)))</span>

   <span class="n">pure</span> <span class="p">(</span> <span class="n">artistName</span> <span class="n">artist_</span><span class="p">,</span> <span class="n">albumTitle</span> <span class="n">album_</span><span class="p">,</span> <span class="n">genreName</span> <span class="n">genre_</span> <span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-5-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;Title&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;Name&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
          <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
          <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
          <span class="k">MAX</span><span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">))</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span>
   <span class="k">FROM</span> <span class="ss">&quot;Track&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
   <span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">,</span>
            <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Genre&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Album&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t2&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span><span class="p">)</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Artist&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t3&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t2&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t3&quot;</span><span class="p">.</span><span class="ss">&quot;ArtistId&quot;</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res3&quot;</span><span class="p">))</span>
  <span class="k">AND</span> <span class="p">((</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="k">ANY</span>
         <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;sub_t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span>
          <span class="k">FROM</span> <span class="ss">&quot;Track&quot;</span> <span class="k">AS</span> <span class="ss">&quot;sub_t0&quot;</span>
          <span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;sub_t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span>
          <span class="k">HAVING</span> <span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="ss">&quot;sub_t0&quot;</span><span class="p">.</span><span class="ss">&quot;GenreId&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">&quot;sub_t0&quot;</span><span class="p">.</span><span class="ss">&quot;AlbumId&quot;</span> <span class="k">ASC</span><span class="p">))</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h2 id="reusing-queries-multiple-times">Reusing queries multiple times</h2>
<p>Suppose we wanted to ask the question, "which albums have tracks under the same
genre?". One easy way of doing this is to do multiple self-joins.</p>
<p>We can also use a common table expression.</p>
<p>Let's call albums <code>A</code> and <code>B</code> "genre-related" if <code>A</code> and <code>B</code> contain at least
one track under the same genre. Then, the queries above answer if <code>A</code> and <code>B</code>
are "genre-related". A natural extension of the question above then is "Which
albums are genre-related to the same album?". For example, suppose <code>A</code> has Jazz
and Rock tracks, <code>B</code> has Rock and Country tracks, and <code>C</code> has Country and Blues
tracks. Then, <code>(A, B)</code> and <code>(B, C)</code> will both be results of the query above, but
<code>(A, C)</code> will not. We can output tuples like <code>(A, C)</code> by self-joining on the
results of the same CTE.</p>
<h2 id="recursive-queries">Recursive queries</h2>
<p>Okay, so the next natural extension is to extend this relation by relating any
two albums <code>A</code> and <code>D</code> where there exist <code>B</code> and <code>C</code> such that <code>A</code> is related to
<code>B</code>, <code>B</code> is related to <code>C</code>, and <code>C</code> is related to <code>D</code>. We can keep extending
this query forever, but the queries above require that we specify all lengths
we're interested in. Conceptually, we could express in Haskell an infinite query:</p>
<p>However, the query generator will loop when serializing this query, because
database systems don't operate on laziness they way Haskell does!</p>
<p>To solve this, some RDBMS systems offer "recursive" queries <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>. The canonical
example of a recursive query is the Fibonacci sequence:</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-6-Haskell" aria-controls="tab-6-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-6-Postgres" aria-controls="tab-6-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-6-Haskell">
            <div class="codehilite"><pre><span></span><span class="nf">void</span> <span class="o">$</span> <span class="n">runSelectReturningList</span> <span class="o">$</span> <span class="n">selectWith</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="n">rec</span> <span class="n">fib</span> <span class="ow">&lt;-</span> <span class="n">selecting</span> <span class="p">(</span><span class="n">pure</span> <span class="p">(</span><span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">as_</span> <span class="o">@</span><span class="kt">Int32</span> <span class="mi">1</span><span class="p">)</span> <span class="p">`</span><span class="n">union_</span><span class="p">`</span>
                        <span class="p">(</span><span class="kr">do</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">reuse</span> <span class="n">fib</span>
                            <span class="n">guard_</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;.</span> <span class="mi">1000</span><span class="p">)</span>
                            <span class="n">pure</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)))</span>
  <span class="n">pure</span> <span class="p">(</span><span class="n">reuse</span> <span class="n">fib</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-6-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="ss">&quot;cte0&quot;</span><span class="p">(</span><span class="ss">&quot;res0&quot;</span><span class="p">,</span>
                      <span class="ss">&quot;res1&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
                                    <span class="p">(</span><span class="k">SELECT</span> <span class="mi">0</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
                                            <span class="mi">1</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">)</span>
                                  <span class="k">UNION</span>
                                    <span class="p">(</span><span class="k">SELECT</span> <span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
                                            <span class="p">(</span><span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span>
                                     <span class="k">FROM</span> <span class="ss">&quot;cte0&quot;</span> <span class="k">AS</span> <span class="ss">&quot;cte0_0&quot;</span>
                                     <span class="k">WHERE</span> <span class="p">(</span><span class="ss">&quot;cte0_0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1000</span><span class="p">)))</span>
<span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res0&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;res1&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;cte0&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span><span class="p">;</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>"Recursive" here is in quotes, because this is not true, general recursion,
   but rather iteration. Still the term "recursive" has stuck around, so Beam
   adopts the convention.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../advanced-features/" title="Advanced features" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Advanced features
              </span>
            </div>
          </a>
        
        
          <a href="../../extensibility/" title="Custom queries" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Custom queries
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    

      <script src="../../../assets/javascripts/application.8e03edeb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    
<script type="text/javascript" language="javascript"  src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript" language="javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" language="javascript">
 $(document.body).tab();
 $(".nav-item:first-child").tab("show");
</script>

  </body>
</html>