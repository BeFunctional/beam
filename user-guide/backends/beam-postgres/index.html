


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-5.0.2">
    
    
      
        <title>beam-postgres - Beam Documentation</title>
      
    
    

      <link rel="stylesheet" href="../../../assets/stylesheets/main.07c9fbf5.min.css">
      
      
    
<link rel="stylesheet" type="text/css" href="../../../css/beam.css"/>

    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../docs/theme/css/beam.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#postgres-specific-data-types" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../../.." title="Beam Documentation" class="md-header-nav__button md-logo" aria-label="Beam Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Beam Documentation
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              beam-postgres
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/haskell-beam/beam/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    haskell-beam/beam
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Beam Documentation" class="md-nav__button md-logo" aria-label="Beam Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    Beam Documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/haskell-beam/beam/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    haskell-beam/beam
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../about/faq/" title="Frequently Asked Questions" class="md-nav__link">
      Frequently Asked Questions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Tutorial
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Tutorial" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorials/tutorial1/" title="Part 1" class="md-nav__link">
      Part 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorials/tutorial2/" title="Part 2" class="md-nav__link">
      Part 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorials/tutorial3/" title="Part 3" class="md-nav__link">
      Part 3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      User Guide
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="User Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../models/" title="Models" class="md-nav__link">
      Models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../databases/" title="Databases" class="md-nav__link">
      Databases
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Backends" class="md-nav__link">
      Backends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../expressions/" title="Expressions" class="md-nav__link">
      Expressions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-5" type="checkbox" id="nav-4-5">
    
    <label class="md-nav__link" for="nav-4-5">
      Queries
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Queries" data-md-level="2">
      <label class="md-nav__title" for="nav-4-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Queries
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/basic/" title="Basic Queries" class="md-nav__link">
      Basic Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/select/" title="More complex SELECTs" class="md-nav__link">
      More complex SELECTs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/ordering/" title="Ordering" class="md-nav__link">
      Ordering
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/relationships/" title="Relationships" class="md-nav__link">
      Relationships
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/aggregates/" title="Aggregates" class="md-nav__link">
      Aggregates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/combining-queries/" title="Combining queries" class="md-nav__link">
      Combining queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/window-functions/" title="Window functions" class="md-nav__link">
      Window functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/advanced-features/" title="Advanced features" class="md-nav__link">
      Advanced features
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/common-table-expressions/" title="Common table expressions" class="md-nav__link">
      Common table expressions
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../extensibility/" title="Custom queries" class="md-nav__link">
      Custom queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-7" type="checkbox" id="nav-4-7">
    
    <label class="md-nav__link" for="nav-4-7">
      Data Manipulation
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Data Manipulation" data-md-level="2">
      <label class="md-nav__title" for="nav-4-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Data Manipulation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../manipulation/insert/" title="INSERT" class="md-nav__link">
      INSERT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../manipulation/update/" title="UPDATE" class="md-nav__link">
      UPDATE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../manipulation/delete/" title="DELETE" class="md-nav__link">
      DELETE
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Schema management
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Schema management" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Schema management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../schema-guide/migrations/" title="The Migrations Framework" class="md-nav__link">
      The Migrations Framework
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../schema-guide/tool/" title="The beam-migrate tool" class="md-nav__link">
      The beam-migrate tool
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../schema-guide/library/" title="The beam-migrate library" class="md-nav__link">
      The beam-migrate library
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Backends
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Backends" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Backends
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        beam-postgres
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="beam-postgres" class="md-nav__link md-nav__link--active">
      beam-postgres
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#postgres-specific-data-types" class="md-nav__link">
    Postgres-specific data types
  </a>
  
    <nav class="md-nav" aria-label="Postgres-specific data types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-tsvector-and-tsquery-types" class="md-nav__link">
    The tsvector and tsquery types
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#postgres-extensions" class="md-nav__link">
    Postgres extensions
  </a>
  
    <nav class="md-nav" aria-label="Postgres extensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#select-locking-clause" class="md-nav__link">
    SELECT locking clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distinct-on-support" class="md-nav__link">
    DISTINCT ON support
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregates" class="md-nav__link">
    Aggregates
  </a>
  
    <nav class="md-nav" aria-label="Aggregates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#string_agg" class="md-nav__link">
    string_agg
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-conflict" class="md-nav__link">
    ON CONFLICT
  </a>
  
    <nav class="md-nav" aria-label="ON CONFLICT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#specifying-actions" class="md-nav__link">
    Specifying actions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../beam-sqlite/" title="beam-sqlite" class="md-nav__link">
      beam-sqlite
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../custom-backends/" title="Writing a Custom Backend" class="md-nav__link">
      Writing a Custom Backend
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      About
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="About" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/compatibility/" title="Compatibility Matrix" class="md-nav__link">
      Compatibility Matrix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/release-notes/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#postgres-specific-data-types" class="md-nav__link">
    Postgres-specific data types
  </a>
  
    <nav class="md-nav" aria-label="Postgres-specific data types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-tsvector-and-tsquery-types" class="md-nav__link">
    The tsvector and tsquery types
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#postgres-extensions" class="md-nav__link">
    Postgres extensions
  </a>
  
    <nav class="md-nav" aria-label="Postgres extensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#select-locking-clause" class="md-nav__link">
    SELECT locking clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distinct-on-support" class="md-nav__link">
    DISTINCT ON support
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregates" class="md-nav__link">
    Aggregates
  </a>
  
    <nav class="md-nav" aria-label="Aggregates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#string_agg" class="md-nav__link">
    string_agg
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-conflict" class="md-nav__link">
    ON CONFLICT
  </a>
  
    <nav class="md-nav" aria-label="ON CONFLICT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#specifying-actions" class="md-nav__link">
    Specifying actions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/haskell-beam/beam/edit/master/docs/user-guide/backends/beam-postgres.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                  <h1>beam-postgres</h1>
                
                <p>The <code>beam-postgres</code> backend is the most feature complete SQL backend for beam.
The Postgres RDBMS supports most of the standards beam follows, so you can
usually expect most queries to simply work. Additionally, <code>beam-postgres</code> is
part of the standard Beam distribution, and so upgrades are applied
periodically, and new functions are added to achieve feature-parity with the
latest Postgres stable</p>
<h2 id="postgres-specific-data-types">Postgres-specific data types</h2>
<p>Postgres has several data types not available from <code>beam-core</code>. The
<code>beam-postgres</code> library provides several types and functions to make working
with these easier.</p>
<h3 id="the-tsvector-and-tsquery-types">The <code>tsvector</code> and <code>tsquery</code> types</h3>
<p>The <code>tsvector</code> and <code>tsquery</code> types form the basis of full-text search
in Postgres. They correspond to the haskell types <code>TsVector</code> and
<code>TsQuery</code>, which are just newtype-wrappers over <code>ByteString</code>.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-0-Haskell" aria-controls="tab-0-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-0-Postgres" aria-controls="tab-0-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-0-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="nf">pure</span> <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">toTsVector</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="n">english</span><span class="p">)</span> <span class="p">(</span><span class="n">as_</span> <span class="o">@</span><span class="kt">String</span> <span class="p">(</span><span class="n">val_</span> <span class="s">&quot;The quick brown fox jumps over the lazy dog&quot;</span><span class="p">)))</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-0-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span> <span class="s1">&#39;The quick brown fox jumps over the lazy dog&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h2 id="postgres-extensions">Postgres extensions</h2>
<h3 id="select-locking-clause"><code>SELECT</code> locking clause</h3>
<p>Postgres allows you to explicitly lock rows retrieved during a select
using the <a href="https://www.postgresql.org/docs/current/static/explicit-locking.html">locking
clause</a>.</p>
<p>Beam supports most of the Postgres locking clause. However, there are some
invariants that are currently not checked at compile time. For example, Postgres
does not allow locking clauses with queries that use <code>UNION</code>, <code>EXCEPT</code>, or
<code>INTERSECT</code> or those with aggregates. Since all these queries have the same type
in Beam, we cannot catch these errors at compile-time. Current guidance is to
only use the locking clause in top-level queries that you know to be
safe.</p>
<p>The following example finds all customers living in Dublin, and requests a <code>ROW
SHARE</code> lock for each row. This prevents concurrent updates from updating these
rows until the current transaction is complete.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-1-Haskell" aria-controls="tab-1-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-1-Postgres" aria-controls="tab-1-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-1-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthShare</span> <span class="kt">Nothing</span> <span class="o">$</span>
  <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Dublin&quot;</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-1-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dublin&#39;</span><span class="p">)</span>
  <span class="k">FOR</span> <span class="k">SHARE</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>Now, suppose we want to update these rows, so we'll want to lock them for an update.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-2-Haskell" aria-controls="tab-2-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-2-Postgres" aria-controls="tab-2-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-2-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthUpdate</span> <span class="kt">Nothing</span> <span class="o">$</span>
  <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Dublin&quot;</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-2-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dublin&#39;</span><span class="p">)</span>
  <span class="k">FOR</span>
  <span class="k">UPDATE</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>However, because there may be a lot of customers in Dublin that we'd like to
update, this may block for a long time. Perhaps, we'd only like to lock rows
that aren't already locked. This is inconsistent in general, but we do not
always care.  Postgres offers the <code>SKIP LOCKED</code> clause for this</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-3-Haskell" aria-controls="tab-3-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-3-Postgres" aria-controls="tab-3-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-3-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthUpdate</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsSkipLocked</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Dublin&quot;</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-3-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dublin&#39;</span><span class="p">)</span>
  <span class="k">FOR</span>
  <span class="k">UPDATE</span> <span class="n">SKIP</span> <span class="n">LOCKED</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>Or, if we do care, and don't want to wait anyway, we can ask Postgres to fail
early instead of blocking, using <code>NO WAIT</code></p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-4-Haskell" aria-controls="tab-4-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-4-Postgres" aria-controls="tab-4-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-4-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthUpdate</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsNoWait</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Dublin&quot;</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-4-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dublin&#39;</span><span class="p">)</span>
  <span class="k">FOR</span>
  <span class="k">UPDATE</span> <span class="n">NOWAIT</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>We can also specify the locking clauses when <code>JOIN</code>ing. Suppose we want to get
all customers who live in London <em>and</em> have a support rep who lives in Paris,
and skipping rows that we can't lock.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-5-Haskell" aria-controls="tab-5-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-5-Postgres" aria-controls="tab-5-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-5-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthShare</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsSkipLocked</span><span class="p">)</span> <span class="o">$</span>
  <span class="kr">do</span> <span class="n">customer</span> <span class="ow">&lt;-</span> <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;London&quot;</span><span class="p">)</span> <span class="o">$</span>
                 <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">employee</span> <span class="ow">&lt;-</span> <span class="n">join_</span> <span class="p">(</span><span class="n">employee</span> <span class="n">chinookDb</span><span class="p">)</span>
                       <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">employeeAddress</span> <span class="n">e</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Paris&quot;</span> <span class="o">&amp;&amp;.</span>
                              <span class="n">just_</span> <span class="p">(</span><span class="n">pk</span> <span class="n">e</span><span class="p">)</span> <span class="o">==.</span> <span class="n">customerSupportRep</span> <span class="n">customer</span><span class="p">)</span>
     <span class="n">pure</span> <span class="p">(</span><span class="n">customerFirstName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">customerLastName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">pk</span> <span class="n">employee</span><span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-5-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Employee&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span> <span class="k">ON</span> <span class="p">((</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Paris&#39;</span><span class="p">))</span>
<span class="k">AND</span> <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">DISTINCT</span>
     <span class="k">FROM</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span><span class="p">))</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">)</span>
  <span class="k">FOR</span> <span class="k">SHARE</span> <span class="n">SKIP</span> <span class="n">LOCKED</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>You may notice that this query will lock rows in both the customers and
employees table. This may not be what you want. You can also specify which
tables to lock by using the <code>lockingFor_</code> function. This requires you to specify
which locks you want to hold by returning them from your query. For example, to
lock only the customers table</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-6-Haskell" aria-controls="tab-6-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-6-Postgres" aria-controls="tab-6-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-6-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthShare</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsSkipLocked</span><span class="p">)</span> <span class="o">$</span>
  <span class="kr">do</span> <span class="p">(</span><span class="n">customerLock</span><span class="p">,</span> <span class="n">customer</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="kt">Pg</span><span class="o">.</span><span class="n">locked_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">guard_</span> <span class="p">(</span><span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">customer</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;London&quot;</span><span class="p">)</span>
     <span class="n">employee</span> <span class="ow">&lt;-</span> <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">employeeAddress</span> <span class="n">e</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Paris&quot;</span> <span class="o">&amp;&amp;.</span>
                                <span class="n">just_</span> <span class="p">(</span><span class="n">pk</span> <span class="n">e</span><span class="p">)</span> <span class="o">==.</span> <span class="n">customerSupportRep</span> <span class="n">customer</span><span class="p">)</span> <span class="o">$</span>
                 <span class="n">all_</span> <span class="p">(</span><span class="n">employee</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">pure</span> <span class="p">((</span><span class="n">customerFirstName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">customerLastName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">pk</span> <span class="n">employee</span><span class="p">)</span> <span class="p">`</span><span class="kt">Pg</span><span class="o">.</span><span class="n">withLocks_</span><span class="p">`</span> <span class="n">customerLock</span><span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-6-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="ss">&quot;Employee&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">))</span>
  <span class="k">AND</span> <span class="p">(((</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Paris&#39;</span><span class="p">))</span>
       <span class="k">AND</span> <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">DISTINCT</span>
            <span class="k">FROM</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span><span class="p">)))</span>
  <span class="k">FOR</span> <span class="k">SHARE</span> <span class="k">OF</span> <span class="ss">&quot;t0&quot;</span> <span class="n">SKIP</span> <span class="n">LOCKED</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>In order to use the explicit locking clause, you need to use the <code>locked_</code>
function to get a reference to a lock for a particular table. This forces the
locked table to be part of the join, which is a requirement for the Postgres
locking clause. You can think of <code>locked_</code> as exactly like <code>all_</code>, except it
returns a table lock as the first return value.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Locks can be combined monoidally, using <code>mappend</code> or <code>(&lt;&gt;)</code>. You can use this
to lock multiple tables, by passing the result of <code>mappend</code> to <code>withLocks_</code>.</p>
<p>If you return <code>mempty</code> as the first argument, then this recovers the standard
behavior of locking all tables.</p>
</div>
<p><code>lockingFor_</code> is the most general locking combinator. You can recover the same
behavior as <code>lockingAllTablesFor_</code> by using the <code>lockAll_</code> function.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-7-Haskell" aria-controls="tab-7-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-7-Postgres" aria-controls="tab-7-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-7-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthShare</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsSkipLocked</span><span class="p">)</span> <span class="o">$</span>
  <span class="kr">do</span> <span class="p">(</span><span class="n">customerLock</span><span class="p">,</span> <span class="n">customer</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="kt">Pg</span><span class="o">.</span><span class="n">locked_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">guard_</span> <span class="p">(</span><span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">customer</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;London&quot;</span><span class="p">)</span>
     <span class="n">employee</span> <span class="ow">&lt;-</span> <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">employeeAddress</span> <span class="n">e</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Paris&quot;</span> <span class="o">&amp;&amp;.</span>
                                <span class="n">just_</span> <span class="p">(</span><span class="n">pk</span> <span class="n">e</span><span class="p">)</span> <span class="o">==.</span> <span class="n">customerSupportRep</span> <span class="n">customer</span><span class="p">)</span> <span class="o">$</span>
                 <span class="n">all_</span> <span class="p">(</span><span class="n">employee</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">pure</span> <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">lockAll_</span> <span class="p">(</span><span class="n">customerFirstName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">customerLastName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">pk</span> <span class="n">employee</span><span class="p">))</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-7-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="ss">&quot;Employee&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">))</span>
  <span class="k">AND</span> <span class="p">(((</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Paris&#39;</span><span class="p">))</span>
       <span class="k">AND</span> <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">DISTINCT</span>
            <span class="k">FROM</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span><span class="p">)))</span>
  <span class="k">FOR</span> <span class="k">SHARE</span> <span class="n">SKIP</span> <span class="n">LOCKED</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Table locks have the type <code>PgLockedTables s</code>, where <code>s</code> is the thread
parameter, as described
<a href="../../queries/basic/#the-q-data-type">here</a></p>
</div>
<h3 id="distinct-on-support"><code>DISTINCT ON</code> support</h3>
<p>Postgres supports the <code>DISTINCT ON</code> clause with selects to return distinct
results based on a particular key. The <code>beam-postgres</code> package provides the
<code>pgNubBy_</code> function to use this feature.</p>
<p>For example, to get an arbitrary customer from each distinct area code</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-8-Haskell" aria-controls="tab-8-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-8-Postgres" aria-controls="tab-8-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-8-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="kt">Pg</span><span class="o">.</span><span class="n">pgNubBy_</span> <span class="p">(</span><span class="n">addressPostalCode</span> <span class="o">.</span> <span class="n">customerAddress</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-8-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span><span class="p">)</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h3 id="aggregates">Aggregates</h3>
<h4 id="string_agg"><code>string_agg</code></h4>
<p>The Postgres <code>string_agg</code> aggregate combines all column values in a group
separated by a given separator. <code>beam-postgres</code> provides <code>pgStringAgg</code> and
<code>pgStringAggOver</code> to use the unquantified and quantified versions of the
<code>string_agg</code> aggregate appropriately.</p>
<p>For example, to put together a list of all cities in all the postal codes we have for customers,</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-9-Haskell" aria-controls="tab-9-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-9-Postgres" aria-controls="tab-9-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-9-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="nf">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">addressPostalCode</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span>
                  <span class="p">,</span> <span class="kt">Pg</span><span class="o">.</span><span class="n">pgStringAgg</span> <span class="p">(</span><span class="n">coalesce_</span> <span class="p">[</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">)]</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-9-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="n">string_agg</span><span class="p">(</span><span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>The above will include one city multiple times if its shared by multiple customers.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-10-Haskell" aria-controls="tab-10-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-10-Postgres" aria-controls="tab-10-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-10-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="nf">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">addressPostalCode</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span>
                  <span class="p">,</span> <span class="kt">Pg</span><span class="o">.</span><span class="n">pgStringAggOver</span> <span class="n">distinctInGroup_</span> <span class="p">(</span><span class="n">coalesce_</span> <span class="p">[</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">)]</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-10-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="n">string_agg</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h3 id="on-conflict">ON CONFLICT</h3>
<p>Postgres supports targeting a particular constraint as the target of an <code>ON CONFLICT</code> clause. You
can use <code>conflictingConstraint</code> with the name of the constraint with the regular <code>insertOnConflict</code>
function to use this functionality.</p>
<p>For example, to update the row, only on conflicts relating to the <code>"PK_CUSTOMER"</code> constraint.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-11-Haskell" aria-controls="tab-11-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-11-Postgres" aria-controls="tab-11-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-11-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="o">--!</span> <span class="kr">import</span> <span class="nn">Database.Beam.Backend.SQL.BeamExtensions</span> <span class="p">(</span><span class="kt">BeamHasInsertOnConflict</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
<span class="o">--!</span> <span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Database.Beam.Postgres</span> <span class="k">as</span> <span class="n">Pg</span>
<span class="kr">let</span>
  <span class="n">newCustomer</span> <span class="ow">=</span> <span class="kt">Customer</span> <span class="mi">42</span> <span class="s">&quot;John&quot;</span> <span class="s">&quot;Doe&quot;</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Address</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;Street&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;City&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;State&quot;</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span> <span class="s">&quot;john.doe@johndoe.com&quot;</span> <span class="n">nothing_</span>

<span class="nf">runInsert</span> <span class="o">$</span>
  <span class="n">insertOnConflict</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="n">insertValues</span> <span class="p">[</span><span class="n">newCustomer</span><span class="p">])</span>
    <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">conflictingConstraint</span> <span class="s">&quot;PK_Customer&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">onConflictUpdateSet</span> <span class="p">(</span><span class="nf">\</span><span class="n">fields</span> <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">fields</span> <span class="o">&lt;-.</span> <span class="n">val_</span> <span class="n">newCustomer</span><span class="p">))</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-11-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;Customer&quot;</span><span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;FirstName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;LastName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Company&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Address&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;City&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;State&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Country&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;PostalCode&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Phone&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Fax&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Email&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;SupportRepId&quot;</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="s1">&#39;Doe&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;Street&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;john.doe@johndoe.com&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span> <span class="k">ON</span> <span class="n">CONFLICT</span> <span class="k">ON</span> <span class="k">CONSTRAINT</span> <span class="ss">&quot;PK_Customer&quot;</span> <span class="k">DO</span>
<span class="k">UPDATE</span>
<span class="k">SET</span> <span class="ss">&quot;CustomerId&quot;</span><span class="o">=</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span>
    <span class="ss">&quot;FirstName&quot;</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;John&#39;</span><span class="p">),</span>
    <span class="ss">&quot;LastName&quot;</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Doe&#39;</span><span class="p">),</span>
    <span class="ss">&quot;Company&quot;</span><span class="o">=</span><span class="p">(</span><span class="k">null</span><span class="p">),</span>
    <span class="ss">&quot;Address&quot;</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Street&#39;</span><span class="p">),</span>
    <span class="ss">&quot;City&quot;</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;City&#39;</span><span class="p">),</span>
    <span class="ss">&quot;State&quot;</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;State&#39;</span><span class="p">),</span>
    <span class="ss">&quot;Country&quot;</span><span class="o">=</span><span class="p">(</span><span class="k">null</span><span class="p">),</span>
    <span class="ss">&quot;PostalCode&quot;</span><span class="o">=</span><span class="p">(</span><span class="k">null</span><span class="p">),</span>
    <span class="ss">&quot;Phone&quot;</span><span class="o">=</span><span class="p">(</span><span class="k">null</span><span class="p">),</span>
    <span class="ss">&quot;Fax&quot;</span><span class="o">=</span><span class="p">(</span><span class="k">null</span><span class="p">),</span>
    <span class="ss">&quot;Email&quot;</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;john.doe@johndoe.com&#39;</span><span class="p">),</span>
    <span class="ss">&quot;SupportRepId&quot;</span><span class="o">=</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h4 id="specifying-actions">Specifying actions</h4>
<p>Often times, you do not want to update every field on a conflict. For
example, for upserts, you rarely want to update the primary key. The
function <code>onConflictUpdateInstead</code> allows you to restrict which fields
are updated in the case of a conflict. The required function argument
is a projection of which fields ought to be updated.</p>
<p>In the example below, we insert a new row, but if a row with the given
primary key already exists, we update <em>only</em> the first and last name.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-12-Haskell" aria-controls="tab-12-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-12-Postgres" aria-controls="tab-12-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-12-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="c1">-- import qualified Database.Beam.Postgres as Pg</span>
<span class="kr">let</span>
  <span class="n">newCustomer</span> <span class="ow">=</span> <span class="kt">Customer</span> <span class="mi">42</span> <span class="s">&quot;John&quot;</span> <span class="s">&quot;Doe&quot;</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Address</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;Street&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;City&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;State&quot;</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span> <span class="s">&quot;john.doe@johndoe.com&quot;</span> <span class="n">nothing_</span>

<span class="nf">runInsert</span> <span class="o">$</span>
  <span class="kt">Pg</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="n">insertValues</span> <span class="p">[</span><span class="n">newCustomer</span><span class="p">])</span> <span class="o">$</span>
    <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflict</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">conflictingFields</span> <span class="n">primaryKey</span><span class="p">)</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">onConflictUpdateInstead</span>
         <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">customerFirstName</span> <span class="n">c</span>
                <span class="p">,</span> <span class="n">customerLastName</span> <span class="n">c</span> <span class="p">)))</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-12-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;Customer&quot;</span><span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;FirstName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;LastName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Company&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Address&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;City&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;State&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Country&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;PostalCode&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Phone&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Fax&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Email&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;SupportRepId&quot;</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="s1">&#39;Doe&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;Street&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;john.doe@johndoe.com&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span> <span class="k">ON</span> <span class="n">CONFLICT</span> <span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">)</span> <span class="k">DO</span>
<span class="k">UPDATE</span>
<span class="k">SET</span> <span class="ss">&quot;FirstName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span><span class="p">),</span>
    <span class="ss">&quot;LastName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span><span class="p">);</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>You can also specify a more specific update, using the
<code>onConflictUpdateSet</code> function. This is the most general form of the
postgres <code>ON CONFLICT</code> action. The <code>excluded</code> table is provided as the
second argument. The syntax of the updates is similar to that of
<code>update</code>.</p>
<p>In the following example, we append the old first name to the new
first name and replace the old last name.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-28-Haskell" aria-controls="tab-28-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-28-Postgres" aria-controls="tab-28-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-28-Haskell">
            <div class="codehilite"><pre><span></span><code><span class="c1">-- import qualified Database.Beam.Postgres as Pg</span>
<span class="kr">let</span>
  <span class="n">newCustomer</span> <span class="ow">=</span> <span class="kt">Customer</span> <span class="mi">42</span> <span class="s">&quot;John&quot;</span> <span class="s">&quot;Doe&quot;</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Address</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;Street&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;City&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;State&quot;</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span> <span class="s">&quot;john.doe@johndoe.com&quot;</span> <span class="n">nothing_</span>

<span class="nf">runInsert</span> <span class="o">$</span>
  <span class="kt">Pg</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="n">insertValues</span> <span class="p">[</span><span class="n">newCustomer</span><span class="p">])</span> <span class="o">$</span>
    <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflict</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">conflictingFields</span> <span class="n">primaryKey</span><span class="p">)</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">onConflictUpdateSet</span>
        <span class="c1">-- tbl is the old row, tblExcluded is the row proposed for insertion</span>
        <span class="p">(</span><span class="nf">\</span><span class="n">tbl</span> <span class="n">tblExcluded</span> <span class="ow">-&gt;</span> <span class="n">mconcat</span>
          <span class="p">[</span> <span class="n">customerFirstName</span> <span class="n">tbl</span> <span class="o">&lt;-.</span> <span class="n">concat_</span> <span class="p">[</span> <span class="n">current_</span> <span class="p">(</span><span class="n">customerFirstName</span> <span class="n">tbl</span><span class="p">),</span>  <span class="n">customerFirstName</span> <span class="n">tblExcluded</span> <span class="p">]</span>
          <span class="p">,</span> <span class="n">customerLastName</span> <span class="n">tbl</span> <span class="o">&lt;-.</span> <span class="n">customerLastName</span> <span class="n">tblExcluded</span> <span class="p">]</span>
        <span class="p">)</span>
      <span class="p">)</span>
</code></pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-28-Postgres">
            <div class="codehilite"><pre><span></span><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;Customer&quot;</span><span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;FirstName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;LastName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Company&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Address&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;City&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;State&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Country&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;PostalCode&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Phone&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Fax&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Email&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;SupportRepId&quot;</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="s1">&#39;Doe&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;Street&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;john.doe@johndoe.com&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span> <span class="k">ON</span> <span class="n">CONFLICT</span> <span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">)</span> <span class="k">DO</span>
<span class="k">UPDATE</span>
<span class="k">SET</span> <span class="ss">&quot;FirstName&quot;</span><span class="o">=</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="ss">&quot;Customer&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span><span class="p">,</span> <span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span><span class="p">)),</span>
    <span class="ss">&quot;LastName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span><span class="p">);</span>
</code></pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../../schema-guide/library/" title="The beam-migrate library" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                The beam-migrate library
              </div>
            </div>
          </a>
        
        
          <a href="../beam-sqlite/" title="beam-sqlite" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                beam-sqlite
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    

      <script src="../../../assets/javascripts/vendor.36cbf620.min.js"></script>
      <script src="../../../assets/javascripts/bundle.00c583dd.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: [],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.7f7c8775.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
<script type="text/javascript" language="javascript"  src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript" language="javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" language="javascript">
 $(document.body).tab();
 $(".nav-item:first-child").tab("show");
</script>

  </body>
</html>